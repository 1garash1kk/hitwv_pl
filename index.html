import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { getFirestore, collection, doc, setDoc, deleteDoc, onSnapshot, query, orderBy } from 'firebase/firestore';
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth';

// --- ã‚¢ã‚¤ã‚³ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ (Lucide React) ---
const HomeIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
const CalendarDaysIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>;
const PlusSquareIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M8 12h8"/><path d="M12 8v8"/></svg>;
const UsersIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>;
const MountainIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m8 3 4 8 5-5 5 15H2L8 3z"/></svg>;
const ListIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" x2="21" y1="6" y2="6"/><line x1="8" x2="21" y1="12" y2="12"/><line x1="8" x2="21" y1="18" y2="18"/><line x1="3" x2="3.01" y1="6" y2="6"/><line x1="3" x2="3.01" y1="12" y2="12"/><line x1="3" x2="3.01" y1="18" y2="18"/></svg>;
const FileTextIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M16 13H8"/><path d="M16 17H8"/><path d="M10 9H8"/></svg>;
const ChevronLeftIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>;
const ChevronRightIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>;
const Trash2Icon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
const EditIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
const ExternalLinkIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></svg>;
const AlertTriangleIcon = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>;

// --- App ID ---
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ ---
const initialMembers = [
  { id: '1', name: 'å±±ç”° å¤ªéƒ', grade: 'W3', license: true },
  { id: '2', name: 'éˆ´æœ¨ èŠ±å­', grade: 'W2', license: true },
  { id: '3', name: 'ä½è—¤ æ¬¡éƒ', grade: 'W2', license: false },
  { id: '4', name: 'ç”°ä¸­ ä¸‰éƒ', grade: 'W1', license: false },
  { id: '5', name: 'é«˜æ©‹ å››éƒ', grade: 'W3', license: true },
];

const initialSchedules = {
  '1': { '2025-08-15': 'ã€‡', '2025-08-16': 'ã€‡', '2025-09-01': 'â–³' },
  '2': { '2025-08-15': 'ã€‡', '2025-08-17': 'Ã—', '2025-09-01': 'ã€‡' },
  '3': { '2025-08-15': 'â–³', '2025-08-20': 'ã€‡' },
  '4': { '2025-08-16': 'ã€‡', '2025-09-01': 'ã€‡' },
  '5': { '2025-08-15': 'ã€‡', '2025-09-01': 'ã€‡' },
};

const initialPlans = [
  { id: 'p1', name: 'å¤åˆå®¿ï¼ˆåŒ—ã‚¢ãƒ«ãƒ—ã‚¹ï¼‰', startDate: '2025-08-15', endDate: '2025-08-18', url: 'https://example.com/plan1', members: ['1', '2', '3'], inTownMembers: [], status: 'æå‡ºæ¸ˆ' },
  { id: 'p2', name: 'å¥¥å¤šæ‘©æ—¥å¸°ã‚Šå±±è¡Œ', startDate: '2025-09-01', endDate: '2025-09-01', url: 'https://example.com/plan2', members: ['2', '4', '5'], inTownMembers: [], status: 'æœªæ‰¿èª' },
  { id: 'p3', name: 'ç§‹åˆå®¿åµå¯Ÿ', startDate: '2025-09-20', endDate: '2025-09-22', url: '', members: ['1', '5'], inTownMembers: [], status: 'æœªæå‡º' },
];

const initialMinutes = [
    { id: 'm1', date: '2025-07-28', author: 'å±±ç”° å¤ªéƒ', content: '<h1>7æœˆåº¦å®šä¾‹ä¼šè­°</h1><p>å¤åˆå®¿ã«ã¤ã„ã¦ã®æœ€çµ‚ç¢ºèªã‚’è¡Œã£ãŸã€‚</p><ul><li>æ—¥ç¨‹: 8/15-8/18</li><li>å ´æ‰€: åŒ—ã‚¢ãƒ«ãƒ—ã‚¹</li><li>å‚åŠ è€…: 3å</li></ul>' },
    { id: 'm2', date: '2025-08-04', author: 'éˆ´æœ¨ èŠ±å­', content: '<h1>8æœˆåº¦ç¬¬ä¸€å›ä¼šè­°</h1><p>å¥¥å¤šæ‘©æ—¥å¸°ã‚Šå±±è¡Œã®è¨ˆç”»ã«ã¤ã„ã¦è©±ã—åˆã£ãŸã€‚</p>' },
];


// --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
const formatDate = (dateStr) => {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  if (isNaN(date.getTime())) return '';
  return `${date.getFullYear()}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
};

const getDaysUntil = (dateStr) => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const targetDate = new Date(dateStr);
  targetDate.setHours(0, 0, 0, 0);
  const diffTime = targetDate - today;
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
};

const statusMap = {
  'ã€‡': 'bg-green-100 text-green-800',
  'â–³': 'bg-yellow-100 text-yellow-800',
  'Ã—': 'bg-red-100 text-red-800',
  'æœª': 'bg-slate-100 text-slate-800',
};

const statusText = {
  'ã€‡': 'å‚åŠ ',
  'â–³': 'æœªå®š',
  'Ã—': 'ä¸å‚åŠ ',
  'æœª': 'æœªå…¥åŠ›',
};

// --- å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---
const Card = ({ children, className = '' }) => (
  <div className={`bg-white rounded-xl shadow-md p-4 sm:p-6 ${className}`}>
    {children}
  </div>
);

const CardTitle = ({ children }) => (
  <h2 className="text-xl font-bold text-slate-800 mb-4">{children}</h2>
);

const Button = ({ children, onClick, className = '', variant = 'primary' }) => {
  const baseClasses = 'px-4 py-2 rounded-lg font-semibold flex items-center justify-center gap-2 transition-colors focus:outline-none focus:ring-2 focus:ring-offset-2';
  const variants = {
    primary: 'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500',
    secondary: 'bg-slate-200 text-slate-800 hover:bg-slate-300 focus:ring-slate-400',
    danger: 'bg-red-600 text-white hover:bg-red-700 focus:ring-red-500',
    ghost: 'bg-transparent text-slate-600 hover:bg-slate-100 focus:ring-slate-400',
  };
  return <button onClick={onClick} className={`${baseClasses} ${variants[variant]} ${className}`}>{children}</button>;
};

const Input = (props) => (
  <input {...props} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
);

const Select = (props) => (
  <select {...props} className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
);

const Modal = ({ isOpen, title, message, onConfirm, onCancel, showCancel, confirmText = 'OK', confirmVariant = 'primary' }) => {
    if (!isOpen) return null;

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex justify-center items-center p-4">
            <div className="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
                <h3 className="text-lg font-bold text-slate-800 mb-4">{title}</h3>
                <p className="text-slate-600 mb-6">{message}</p>
                <div className="flex justify-end gap-3">
                    {showCancel && <Button onClick={onCancel} variant="secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</Button>}
                    <Button onClick={onConfirm} variant={confirmVariant}>{confirmText}</Button>
                </div>
            </div>
        </div>
    );
};

// --- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ ---

// æ©Ÿèƒ½â‘¢: ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†ãƒšãƒ¼ã‚¸
const MembersPage = ({ members, db, showModal }) => {
  const [newMemberName, setNewMemberName] = useState('');
  const [newMemberGrade, setNewMemberGrade] = useState('W1');
  const [newMemberLicense, setNewMemberLicense] = useState(false);
  const [filter, setFilter] = useState('all');

  const addMember = async () => {
    if (!newMemberName.trim() || !db) {
      showModal({ title: 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', message: 'ãƒ¡ãƒ³ãƒãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', showCancel: false });
      return;
    }
    const newId = new Date().getTime().toString();
    const newMember = { id: newId, name: newMemberName, grade: newMemberGrade, license: newMemberLicense };
    
    try {
      const membersCollectionPath = `artifacts/${appId}/public/data/members`;
      await setDoc(doc(db, membersCollectionPath, newId), newMember);
      setNewMemberName('');
      setNewMemberGrade('W1');
      setNewMemberLicense(false);
    } catch (e) {
      console.error("Error adding document: ", e);
      showModal({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'ãƒ¡ãƒ³ãƒãƒ¼ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', showCancel: false });
    }
  };

  const deleteMember = (id) => {
    const memberToDelete = members.find(m => m.id === id);
    showModal({
        title: 'ãƒ¡ãƒ³ãƒãƒ¼ã®å‰Šé™¤',
        message: `ã€Œ${memberToDelete?.name}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,
        confirmText: 'å‰Šé™¤',
        confirmVariant: 'danger',
        onConfirm: async () => {
            if (!db) return;
            try {
                const membersCollectionPath = `artifacts/${appId}/public/data/members`;
                await deleteDoc(doc(db, membersCollectionPath, id));
            } catch (e) {
                console.error("Error deleting document: ", e);
                showModal({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'ãƒ¡ãƒ³ãƒãƒ¼ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', showCancel: false });
            }
        }
    });
  };

  const handleMemberUpdate = async (memberId, field, value) => {
    if (!db) return;
    try {
        const memberDocRef = doc(db, `artifacts/${appId}/public/data/members`, memberId);
        await setDoc(memberDocRef, { [field]: value }, { merge: true });
    } catch (e) {
        console.error("Error updating member: ", e);
        showModal({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', showCancel: false });
    }
  };

  const filteredMembers = useMemo(() => {
    if (filter === 'all') return members;
    return members.filter(m => m.grade === filter);
  }, [members, filter]);

  return (
    <div className="p-4 sm:p-6 space-y-6">
      <h1 className="text-3xl font-bold text-slate-900">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h1>
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <Card className="lg:col-span-1">
          <CardTitle>æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ </CardTitle>
          <div className="space-y-4">
            <Input type="text" placeholder="æ°å" value={newMemberName} onChange={(e) => setNewMemberName(e.target.value)} />
            <Select value={newMemberGrade} onChange={(e) => setNewMemberGrade(e.target.value)}>
              <option value="W1">W1</option>
              <option value="W2">W2</option>
              <option value="W3">W3</option>
            </Select>
            <label className="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" checked={newMemberLicense} onChange={(e) => setNewMemberLicense(e.target.checked)} className="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" />
              <span className="text-slate-700">å…è¨±ã‚ã‚Š</span>
            </label>
            <Button onClick={addMember} className="w-full">è¿½åŠ </Button>
          </div>
        </Card>

        <Card className="lg:col-span-2">
          <CardTitle>ãƒ¡ãƒ³ãƒãƒ¼ä¸€è¦§</CardTitle>
          <div className="mb-4">
            <div className="flex flex-wrap gap-2">
              <Button variant={filter === 'all' ? 'primary' : 'secondary'} onClick={() => setFilter('all')}>å…¨ã¦</Button>
              <Button variant={filter === 'W1' ? 'primary' : 'secondary'} onClick={() => setFilter('W1')}>W1</Button>
              <Button variant={filter === 'W2' ? 'primary' : 'secondary'} onClick={() => setFilter('W2')}>W2</Button>
              <Button variant={filter === 'W3' ? 'primary' : 'secondary'} onClick={() => setFilter('W3')}>W3</Button>
            </div>
          </div>
          <div className="overflow-x-auto -mx-4 sm:-mx-6">
            <table className="min-w-full divide-y divide-slate-200">
              <thead className="bg-slate-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">æ°å</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ç­‰ç´š</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">å…è¨±</th>
                  <th className="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider">æ“ä½œ</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-slate-200">
                {filteredMembers.map(member => (
                  <tr key={member.id} className="hover:bg-slate-50">
                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">{member.name} {member.license && 'ğŸš—'}</td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <Select
                        value={member.grade}
                        onChange={(e) => handleMemberUpdate(member.id, 'grade', e.target.value)}
                        className="text-sm p-1"
                      >
                        <option value="W1">W1</option>
                        <option value="W2">W2</option>
                        <option value="W3">W3</option>
                      </Select>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <input
                        type="checkbox"
                        checked={member.license}
                        onChange={(e) => handleMemberUpdate(member.id, 'license', e.target.checked)}
                        className="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500"
                      />
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                      <Button onClick={() => deleteMember(member.id)} variant="ghost" className="text-red-600 hover:text-red-800"><Trash2Icon /></Button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </Card>
      </div>
    </div>
  );
};


// æ©Ÿèƒ½â‘ : ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å…¥åŠ›ãƒšãƒ¼ã‚¸
const SchedulePage = ({ members, schedules, db, showModal }) => {
  const [currentDate, setCurrentDate] = useState(new Date());
  const [selectedUser, setSelectedUser] = useState(members[0]?.id || '');

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDayOfMonth = new Date(year, month, 1).getDay();

  const calendarDays = useMemo(() => {
    const days = [];
    for (let i = 0; i < firstDayOfMonth; i++) {
      days.push({ key: `empty-${i}`, empty: true });
    }
    for (let day = 1; day <= daysInMonth; day++) {
      days.push({ key: `${year}-${month}-${day}`, day, date: new Date(year, month, day) });
    }
    return days;
  }, [year, month, daysInMonth, firstDayOfMonth]);

  const handleStatusChange = async (dateStr, status) => {
    if (!selectedUser || !db) {
      showModal({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', showCancel: false });
      return;
    }
    const userSchedules = schedules[selectedUser] || {};
    const newSchedules = {
      ...schedules,
      [selectedUser]: {
        ...userSchedules,
        [dateStr]: status,
      }
    };
    
    try {
        const schedulesCollectionPath = `artifacts/${appId}/public/data/schedules`;
        const scheduleRef = doc(db, schedulesCollectionPath, selectedUser);
        await setDoc(scheduleRef, { schedules: newSchedules[selectedUser] }, { merge: true });
    } catch (e) {
        console.error("Error updating schedule: ", e);
        showModal({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', showCancel: false });
    }
  };

  const changeMonth = (offset) => {
    setCurrentDate(new Date(year, month + offset, 1));
  };

  useEffect(() => {
      if (members.length > 0 && !selectedUser) {
          setSelectedUser(members[0].id);
      }
  }, [members, selectedUser]);

  return (
    <div className="p-4 sm:p-6">
      <h1 className="text-3xl font-bold text-slate-900 mb-6">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å…¥åŠ›</h1>
      <Card>
        <div className="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
          <Select value={selectedUser} onChange={(e) => setSelectedUser(e.target.value)} className="w-full sm:w-auto">
            <option disabled value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ</option>
            {members.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
          </Select>
          <div className="flex items-center">
            <Button onClick={() => changeMonth(-1)} variant="ghost"><ChevronLeftIcon /></Button>
            <h2 className="text-lg font-semibold mx-4 w-32 text-center">{`${year}å¹´ ${month + 1}æœˆ`}</h2>
            <Button onClick={() => changeMonth(1)} variant="ghost"><ChevronRightIcon /></Button>
          </div>
        </div>

        <div className="grid grid-cols-7 gap-1 text-center font-semibold text-slate-600">
          {['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].map(day => <div key={day} className="py-2 text-xs sm:text-sm">{day}</div>)}
        </div>
        <div className="grid grid-cols-7 gap-1">
          {calendarDays.map(d => {
            if (d.empty) return <div key={d.key} className="border-t border-slate-200"></div>;
            const dateStr = `${d.date.getFullYear()}-${(d.date.getMonth() + 1).toString().padStart(2, '0')}-${d.date.getDate().toString().padStart(2, '0')}`;
            const status = schedules[selectedUser]?.[dateStr] || '';
            return (
              <div key={d.key} className="border border-slate-200 rounded-lg p-2 h-28 flex flex-col">
                <div className="font-bold text-slate-700 text-sm">{d.day}</div>
                <div className="flex-grow flex items-center justify-center">
                  <Select
                    value={status}
                    onChange={(e) => handleStatusChange(dateStr, e.target.value)}
                    className={`w-full text-sm ${status ? statusMap[status] : 'bg-white'}`}
                    disabled={!selectedUser}
                  >
                    <option value="">-</option>
                    <option value="ã€‡">ã€‡</option>
                    <option value="â–³">â–³</option>
                    <option value="Ã—">Ã—</option>
                  </Select>
                </div>
              </div>
            );
          })}
        </div>
      </Card>
    </div>
  );
};

// æ©Ÿèƒ½â‘¡: è¨ˆç”»ä½œæˆãƒšãƒ¼ã‚¸
const PlanPage = ({ members, schedules, db, showModal }) => {
    const [planName, setPlanName] = useState('');
    const [planUrl, setPlanUrl] = useState('');
    const [startDate, setStartDate] = useState('');
    const [endDate, setEndDate] = useState('');
    const [planMembers, setPlanMembers] = useState([]);
    const [inTownMembers, setInTownMembers] = useState([]);

    const handleStartDateChange = (date) => {
        setStartDate(date);
        if (!endDate || new Date(date) > new Date(endDate)) {
            setEndDate(date);
        }
    };

    const createPlan = async () => {
        if (!planName.trim() || !startDate || !endDate || !db) {
            showModal({ title: 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', message: 'è¨ˆç”»åã¨æ—¥ç¨‹ã¯å¿…é ˆã§ã™ã€‚', showCancel: false });
            return;
        }
        const newId = `plan_${new Date().getTime()}`;
        const newPlan = {
            id: newId, name: planName, url: planUrl, startDate, endDate,
            members: planMembers, inTownMembers, status: 'æœªæ‰¿èª'
        };
        try {
            const plansCollectionPath = `artifacts/${appId}/public/data/plans`;
            await setDoc(doc(db, plansCollectionPath, newId), newPlan);
            setPlanName(''); setPlanUrl(''); setStartDate(''); setEndDate('');
            setPlanMembers([]); setInTownMembers([]);
            showModal({ title: 'æˆåŠŸ', message: 'è¨ˆç”»ã‚’ä½œæˆã—ã¾ã—ãŸã€‚', showCancel: false });
        } catch (e) {
            console.error("Error adding plan: ", e);
            showModal({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'è¨ˆç”»ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚', showCancel: false });
        }
    };
    
    const overallScheduleData = useMemo(() => {
        const data = [];
        const today = new Date();
        for (let i = 0; i < 90; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            const dateStr = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
            const dayData = { date: dateStr, 'ã€‡': [], 'â–³': [], 'Ã—': [], 'æœª': [] };
            members.forEach(member => {
                const status = schedules[member.id]?.[dateStr] || 'æœª';
                dayData[status].push(member.name.split(' ')[0]);
            });
            data.push(dayData);
        }
        return data;
    }, [members, schedules]);

    return (
        <div className="p-4 sm:p-6 space-y-6">
            <h1 className="text-3xl font-bold text-slate-900">è¨ˆç”»ä½œæˆ</h1>
            <Card>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <Input type="text" placeholder="å±±è¡Œå" value={planName} onChange={e => setPlanName(e.target.value)} />
                    <Input type="url" placeholder="è¨ˆç”»æ›¸URL" value={planUrl} onChange={e => setPlanUrl(e.target.value)} />
                    <Input type="date" value={startDate} onChange={e => handleStartDateChange(e.target.value)} />
                    <Input type="date" value={endDate} onChange={e => setEndDate(e.target.value)} />
                </div>
                <div className="mt-6">
                    <h3 className="font-semibold text-slate-700 mb-2">å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼</h3>
                    <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        {members.map(m => (
                            <label key={m.id} className="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" className="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" checked={planMembers.includes(m.id)} onChange={e => {
                                    if(e.target.checked) setPlanMembers([...planMembers, m.id]);
                                    else setPlanMembers(planMembers.filter(id => id !== m.id));
                                }} />
                                <span className="text-slate-700">{m.name}</span>
                            </label>
                        ))}
                    </div>
                </div>
                <div className="mt-6">
                    <h3 className="font-semibold text-slate-700 mb-2">åœ¨äº¬ãƒ¡ãƒ³ãƒãƒ¼ (2åã¾ã§)</h3>
                     <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        {members.filter(m => !planMembers.includes(m.id)).map(m => (
                            <label key={m.id} className="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" className="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" checked={inTownMembers.includes(m.id)} 
                                onChange={e => {
                                    if(e.target.checked) { if(inTownMembers.length < 2) setInTownMembers([...inTownMembers, m.id]); } 
                                    else { setInTownMembers(inTownMembers.filter(id => id !== m.id)); }
                                }} 
                                disabled={inTownMembers.length >= 2 && !inTownMembers.includes(m.id)}
                                />
                                <span className="text-slate-700">{m.name}</span>
                            </label>
                        ))}
                    </div>
                </div>
                <div className="mt-6 text-right">
                    <Button onClick={createPlan}>è¨ˆç”»ã‚’ä½œæˆ</Button>
                </div>
            </Card>

            <Card>
                <CardTitle>å…¨ä½“ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« (3ãƒ¶æœˆ)</CardTitle>
                <div className="overflow-x-auto">
                    <table className="min-w-full border-collapse">
                        <thead>
                            <tr>
                                <th className="sticky left-0 bg-slate-100 p-2 text-sm font-semibold text-slate-600 border-r border-b border-slate-200">çŠ¶æ…‹</th>
                                {overallScheduleData.map(d => {
                                    const date = new Date(d.date);
                                    const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
                                    const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                                    return (
                                        <th key={d.date} className={`p-1 text-xs text-center border-b border-slate-200 ${isWeekend ? 'bg-slate-100' : 'bg-white'}`}>
                                            {`${date.getMonth()+1}/${date.getDate()}`}<br/>({dayOfWeek})
                                        </th>
                                    );
                                })}
                            </tr>
                        </thead>
                        <tbody>
                            {['ã€‡', 'â–³', 'Ã—', 'æœª'].map(status => (
                                <tr key={status}>
                                    <td className={`sticky left-0 p-2 text-center font-bold border-r border-slate-200 ${statusMap[status]}`}>{statusText[status]}</td>
                                    {overallScheduleData.map(d => (
                                        <td key={`${d.date}-${status}`} className="border-t border-slate-200 p-1 text-xs align-top h-24 min-w-[60px]">
                                            <div className="flex flex-wrap gap-1">
                                                {d[status].map((name, i) => (
                                                    <span key={i} className={`px-1.5 py-0.5 rounded text-xs ${statusMap[status]}`}>{name}</span>
                                                ))}
                                            </div>
                                        </td>
                                    ))}
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>
        </div>
    );
};


// æ©Ÿèƒ½â‘£: æ´»å‹•ä¸€è¦§ãƒšãƒ¼ã‚¸
const ActivitiesPage = ({ plans, members, setPage, setSelectedPlan }) => {
    
    const getPlanDetails = (plan) => {
        const planMembersDetails = members.filter(m => plan.members.includes(m.id));
        const driverCount = planMembersDetails.filter(m => m.license).length;
        const w3Count = planMembersDetails.filter(m => m.grade === 'W3').length;
        const daysUntil = getDaysUntil(plan.startDate);
        const deadline = daysUntil - 9;
        return { driverCount, w3Count, daysUntil, deadline };
    };

    const handleEdit = (plan) => {
        setSelectedPlan(plan);
        setPage('PlanDetails');
    };
    
    const statusBadge = (status) => {
        switch(status) {
            case 'æœªæ‰¿èª': return 'bg-yellow-100 text-yellow-800';
            case 'æœªæå‡º': return 'bg-slate-100 text-slate-800';
            case 'æå‡ºæ¸ˆ': return 'bg-blue-100 text-blue-800';
            default: return 'bg-slate-100 text-slate-800';
        }
    };

    return (
        <div className="p-4 sm:p-6">
            <h1 className="text-3xl font-bold text-slate-900 mb-6">æ´»å‹•ä¸€è¦§</h1>
            <Card>
                <div className="overflow-x-auto -mx-4 sm:-mx-6">
                    <table className="min-w-full divide-y divide-slate-200">
                      <thead className="bg-slate-50">
                        <tr>
                          <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">è¨ˆç”»å</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">æ—¥ç¨‹</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">å±±è¡Œã¾ã§</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ç· åˆ‡ã¾ã§</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">é‹è»¢è€…</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">W3</th>
                          <th className="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                          <th className="px-6 py-3 text-right text-xs font-medium text-slate-500 uppercase tracking-wider"></th>
                        </tr>
                      </thead>
                      <tbody className="bg-white divide-y divide-slate-200">
                        {plans.map(plan => {
                            const { driverCount, w3Count, daysUntil, deadline } = getPlanDetails(plan);
                            return (
                                <tr key={plan.id} className="hover:bg-slate-50">
                                    <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">{plan.name}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{formatDate(plan.startDate)} ~ {formatDate(plan.endDate)}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{daysUntil >= 0 ? `${daysUntil}æ—¥` : 'çµ‚äº†'}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{deadline >= 0 ? `${deadline}æ—¥` : '-'}</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{driverCount}äºº</td>
                                    <td className="px-6 py-4 whitespace-nowrap text-sm text-slate-500">{w3Count}äºº</td>
                                    <td className="px-6 py-4 whitespace-nowrap"><span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusBadge(plan.status)}`}>{plan.status}</span></td>
                                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                        <Button onClick={() => handleEdit(plan)} variant="ghost"><EditIcon /></Button>
                                    </td>
                                </tr>
                            );
                        })}
                      </tbody>
                    </table>
                </div>
            </Card>
        </div>
    );
};

// æ´»å‹•è©³ç´°ãƒ»ç·¨é›†ãƒšãƒ¼ã‚¸
const PlanDetailsPage = ({ plan, setPlan, members, setPage, db, showModal }) => {
    const [editablePlan, setEditablePlan] = useState(plan);

    const handleUpdate = async () => {
        if (!db) return;
        try {
            const plansCollectionPath = `artifacts/${appId}/public/data/plans`;
            await setDoc(doc(db, plansCollectionPath, editablePlan.id), editablePlan, { merge: true });
            setPlan(editablePlan);
            showModal({ title: 'æˆåŠŸ', message: 'è¨ˆç”»ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚', showCancel: false });
            setPage('Activities');
        } catch (e) {
            console.error("Error updating plan: ", e);
            showModal({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'è¨ˆç”»ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', showCancel: false });
        }
    };

    const handleDelete = () => {
        showModal({
            title: 'è¨ˆç”»ã®å‰Šé™¤',
            message: `ã€Œ${plan.name}ã€ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚`,
            confirmText: 'å‰Šé™¤',
            confirmVariant: 'danger',
            onConfirm: async () => {
                if (!db) return;
                try {
                    const plansCollectionPath = `artifacts/${appId}/public/data/plans`;
                    await deleteDoc(doc(db, plansCollectionPath, plan.id));
                    showModal({ title: 'æˆåŠŸ', message: 'è¨ˆç”»ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚', showCancel: false, onConfirm: () => setPage('Activities') });
                } catch (e) {
                    console.error("Error deleting plan: ", e);
                    showModal({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'è¨ˆç”»ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', showCancel: false });
                }
            }
        });
    };
    
    const handleMemberChange = (memberId, isChecked) => {
        const newMembers = isChecked ? [...editablePlan.members, memberId] : editablePlan.members.filter(id => id !== memberId);
        setEditablePlan({ ...editablePlan, members: newMembers });
    };

    const handleInTownMemberChange = (memberId, isChecked) => {
        let newInTownMembers = [...editablePlan.inTownMembers];
        if (isChecked) { if (newInTownMembers.length < 2) newInTownMembers.push(memberId); } 
        else { newInTownMembers = newInTownMembers.filter(id => id !== memberId); }
        setEditablePlan({ ...editablePlan, inTownMembers: newInTownMembers });
    };

    return (
        <div className="p-4 sm:p-6">
            <h1 className="text-3xl font-bold text-slate-900 mb-6">è¨ˆç”»è©³ç´°ãƒ»ç·¨é›†</h1>
            <Card>
                <div className="space-y-6">
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">å±±è¡Œå</label>
                        <Input type="text" value={editablePlan.name} onChange={e => setEditablePlan({...editablePlan, name: e.target.value})} />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</label>
                        <Select value={editablePlan.status} onChange={e => setEditablePlan({...editablePlan, status: e.target.value})}>
                            <option>æœªæ‰¿èª</option>
                            <option>æœªæå‡º</option>
                            <option>æå‡ºæ¸ˆ</option>
                        </Select>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">é–‹å§‹æ—¥</label>
                            <Input type="date" value={editablePlan.startDate} onChange={e => setEditablePlan({...editablePlan, startDate: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-slate-700 mb-1">çµ‚äº†æ—¥</label>
                            <Input type="date" value={editablePlan.endDate} onChange={e => setEditablePlan({...editablePlan, endDate: e.target.value})} />
                        </div>
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-slate-700 mb-1">è¨ˆç”»æ›¸URL</label>
                        <div className="flex items-center gap-2">
                            <Input type="url" value={editablePlan.url} onChange={e => setEditablePlan({...editablePlan, url: e.target.value})} />
                            <a href={editablePlan.url} target="_blank" rel="noopener noreferrer" className={`p-2 rounded-lg ${!editablePlan.url ? 'bg-slate-200 text-slate-400 cursor-not-allowed' : 'bg-slate-100 text-slate-600 hover:bg-slate-200'}`}>
                               <ExternalLinkIcon />
                            </a>
                        </div>
                    </div>
                    <div>
                        <h3 className="text-sm font-medium text-slate-700 mb-2">å‚åŠ ãƒ¡ãƒ³ãƒãƒ¼</h3>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                            {members.map(m => (
                                <label key={m.id} className="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" className="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" checked={editablePlan.members.includes(m.id)} onChange={e => handleMemberChange(m.id, e.target.checked)} />
                                    <span className="text-slate-700">{m.name}</span>
                                </label>
                            ))}
                        </div>
                    </div>
                    <div>
                        <h3 className="text-sm font-medium text-slate-700 mb-2">åœ¨äº¬ãƒ¡ãƒ³ãƒãƒ¼ (2åã¾ã§)</h3>
                        <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                             {members.filter(m => !editablePlan.members.includes(m.id)).map(m => (
                                <label key={m.id} className="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" className="h-4 w-4 rounded border-slate-300 text-blue-600 focus:ring-blue-500" checked={editablePlan.inTownMembers.includes(m.id)} 
                                    onChange={e => handleInTownMemberChange(m.id, e.target.checked)} 
                                    disabled={editablePlan.inTownMembers.length >= 2 && !editablePlan.inTownMembers.includes(m.id)}
                                    />
                                    <span className="text-slate-700">{m.name}</span>
                                </label>
                            ))}
                        </div>
                    </div>
                    <div className="flex justify-between items-center pt-6 border-t border-slate-200">
                        <Button onClick={handleDelete} variant="danger">è¨ˆç”»ã‚’å‰Šé™¤</Button>
                        <div className="flex gap-2">
                            <Button onClick={() => setPage('Activities')} variant="secondary">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</Button>
                            <Button onClick={handleUpdate} variant="primary">æ›´æ–°</Button>
                        </div>
                    </div>
                </div>
            </Card>
        </div>
    );
};


// æ©Ÿèƒ½â‘¤: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸
const CalendarPage = ({ plans, setPage, setSelectedPlan }) => {
    const [currentDate, setCurrentDate] = useState(new Date());

    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();

    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const firstDayOfMonth = new Date(year, month, 1).getDay();

    const calendarDays = useMemo(() => {
        const days = [];
        for (let i = 0; i < firstDayOfMonth; i++) {
            days.push({ key: `empty-${i}`, empty: true });
        }
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const plansOnDate = plans.filter(p => {
                const start = new Date(p.startDate); start.setHours(0,0,0,0);
                const end = new Date(p.endDate); end.setHours(0,0,0,0);
                return date >= start && date <= end;
            });
            days.push({ key: `${year}-${month}-${day}`, day, date, plans: plansOnDate });
        }
        return days;
    }, [year, month, daysInMonth, firstDayOfMonth, plans]);

    const changeMonth = (offset) => {
        setCurrentDate(new Date(year, month + offset, 1));
    };
    
    const handlePlanClick = (plan) => {
        setSelectedPlan(plan);
        setPage('PlanDetails');
    };

    return (
        <div className="p-4 sm:p-6">
            <h1 className="text-3xl font-bold text-slate-900 mb-6">æ´»å‹•ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h1>
            <Card>
                <div className="flex justify-center items-center mb-4">
                    <Button onClick={() => changeMonth(-1)} variant="ghost"><ChevronLeftIcon /></Button>
                    <h2 className="text-lg font-semibold mx-4 w-32 text-center">{`${year}å¹´ ${month + 1}æœˆ`}</h2>
                    <Button onClick={() => changeMonth(1)} variant="ghost"><ChevronRightIcon /></Button>
                </div>

                <div className="grid grid-cols-7 gap-1 text-center font-semibold text-slate-600">
                    {['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'].map(day => <div key={day} className="py-2 text-xs sm:text-sm">{day}</div>)}
                </div>
                <div className="grid grid-cols-7 gap-1">
                    {calendarDays.map(d => {
                        if (d.empty) return <div key={d.key} className="border-t border-slate-200"></div>;
                        return (
                            <div key={d.key} className="border border-slate-200 rounded-lg p-1 h-32 flex flex-col overflow-hidden">
                                <div className="font-bold text-slate-700 text-sm text-right pr-1">{d.day}</div>
                                <div className="space-y-1 mt-1 overflow-y-auto">
                                    {d.plans.map(plan => (
                                        <div key={plan.id} onClick={() => handlePlanClick(plan)} className="text-xs bg-blue-100 text-blue-800 p-1 rounded cursor-pointer hover:bg-blue-200 truncate">
                                            {plan.name}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        );
                    })}
                </div>
            </Card>
        </div>
    );
};

// æ©Ÿèƒ½â“ª: ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
const HomePage = ({ plans, members, setPage, setSelectedPlan }) => {
    const unapprovedPlans = plans.filter(p => p.status === 'æœªæ‰¿èª');

    const handlePlanClick = (plan) => {
        setSelectedPlan(plan);
        setPage('PlanDetails');
    };

    const now = new Date();
    const currentYear = now.getFullYear();
    const currentMonth = now.getMonth();

    const hikesThisMonth = plans.filter(plan => {
        const startDate = new Date(plan.startDate);
        return startDate.getFullYear() === currentYear && startDate.getMonth() === currentMonth;
    }).length;

    return (
        <div className="p-4 sm:p-6 space-y-6">
            <h1 className="text-3xl font-bold text-slate-900">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <Card className="md:col-span-2 lg:col-span-2">
                    <CardTitle>ã‚¯ã‚¤ãƒƒã‚¯ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</CardTitle>
                    <div className="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                        <Button onClick={() => setPage('Plan')} variant="primary" className="w-full"><PlusSquareIcon /> è¨ˆç”»ã‚’ä½œæˆ</Button>
                        <Button onClick={() => setPage('Schedule')} variant="secondary" className="w-full"><CalendarDaysIcon /> ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å…¥åŠ›</Button>
                    </div>
                </Card>
                <Card>
                    <CardTitle>éƒ¨å“¡æ•°</CardTitle>
                    <p className="text-3xl font-bold text-slate-900">{members.length}äºº</p>
                </Card>
                <Card>
                    <CardTitle>å½“æœˆã®å±±è¡Œ</CardTitle>
                    <p className="text-3xl font-bold text-slate-900">{hikesThisMonth}å›</p>
                </Card>
            </div>
            <Card>
                <CardTitle>æœªæ‰¿èªã®è¨ˆç”»</CardTitle>
                <div className="space-y-3 max-h-60 overflow-y-auto">
                    {unapprovedPlans.length > 0 ? (
                        unapprovedPlans.map(plan => {
                            const deadline = getDaysUntil(plan.startDate) - 9;
                            return (
                                <div key={plan.id} onClick={() => handlePlanClick(plan)} className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg cursor-pointer hover:bg-yellow-100 transition-colors">
                                    <div className="flex justify-between items-start">
                                        <div>
                                            <p className="font-semibold text-yellow-800">{plan.name}</p>
                                            <p className="text-sm text-slate-600">{formatDate(plan.startDate)} ~ {formatDate(plan.endDate)}</p>
                                        </div>
                                        <div className="text-right shrink-0 ml-4">
                                            <p className="text-sm font-bold text-red-600">ç· åˆ‡</p>
                                            <p className="text-sm text-slate-600">{deadline >= 0 ? `ã‚ã¨${deadline}æ—¥` : 'è¶…é'}</p>
                                        </div>
                                    </div>
                                </div>
                            );
                        })
                    ) : (
                        <p className="text-slate-500">æœªæ‰¿èªã®è¨ˆç”»ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                    )}
                </div>
            </Card>
        </div>
    );
};

// æ–°æ©Ÿèƒ½ï¼šè­°äº‹éŒ²ãƒšãƒ¼ã‚¸
const MinutesPage = ({ minutes, db, showModal }) => {
    const [selectedMinute, setSelectedMinute] = useState(null);
    const [date, setDate] = useState('');
    const [author, setAuthor] = useState('');
    const editorRef = React.useRef(null);

    useEffect(() => {
        if (selectedMinute) {
            setDate(selectedMinute.date);
            setAuthor(selectedMinute.author);
            if(editorRef.current) {
                editorRef.current.innerHTML = selectedMinute.content;
            }
        } else {
            setDate(new Date().toISOString().slice(0, 10));
            setAuthor('');
            if(editorRef.current) {
                editorRef.current.innerHTML = '';
            }
        }
    }, [selectedMinute]);

    const handleSave = async () => {
        if (!date || !author || !editorRef.current) {
            showModal({ title: 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', message: 'æ—¥ä»˜ã¨æ–‡è²¬è€…ã¯å¿…é ˆã§ã™ã€‚', showCancel: false });
            return;
        }

        const content = editorRef.current.innerHTML;
        const minuteData = { date, author, content };
        const id = selectedMinute ? selectedMinute.id : `min_${new Date().getTime()}`;
        
        try {
            const minutesCollectionPath = `artifacts/${appId}/public/data/minutes`;
            await setDoc(doc(db, minutesCollectionPath, id), minuteData);
            showModal({ title: 'æˆåŠŸ', message: 'è­°äº‹éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', showCancel: false });
            if (!selectedMinute) {
                setSelectedMinute({ id, ...minuteData });
            }
        } catch (e) {
            console.error("Error saving minute:", e);
            showModal({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'è­°äº‹éŒ²ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', showCancel: false });
        }
    };
    
    const handleDelete = () => {
        if (!selectedMinute) return;
        showModal({
            title: 'è­°äº‹éŒ²ã®å‰Šé™¤',
            message: `ã“ã®è­°äº‹éŒ²ï¼ˆ${selectedMinute.date}ï¼‰ã‚’æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,
            confirmText: 'å‰Šé™¤',
            confirmVariant: 'danger',
            onConfirm: async () => {
                try {
                    const minutesCollectionPath = `artifacts/${appId}/public/data/minutes`;
                    await deleteDoc(doc(db, minutesCollectionPath, selectedMinute.id));
                    setSelectedMinute(null);
                } catch (e) {
                     showModal({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'è­°äº‹éŒ²ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', showCancel: false });
                }
            }
        });
    };

    const handleFormat = (command) => {
        document.execCommand(command, false, null);
        editorRef.current.focus();
    };

    return (
        <div className="p-4 sm:p-6 h-full flex flex-col lg:flex-row gap-6">
            <div className="lg:w-1/3 shrink-0">
                <h1 className="text-3xl font-bold text-slate-900 mb-6">è­°äº‹éŒ²</h1>
                <Card>
                    <div className="flex justify-between items-center mb-4">
                        <CardTitle>éå»ã®è­°äº‹éŒ²</CardTitle>
                        <Button onClick={() => setSelectedMinute(null)} variant="secondary">æ–°è¦ä½œæˆ</Button>
                    </div>
                    <ul className="space-y-2 max-h-[60vh] overflow-y-auto">
                        {minutes.map(minute => (
                            <li key={minute.id} onClick={() => setSelectedMinute(minute)}
                                className={`p-3 rounded-lg cursor-pointer transition-colors ${selectedMinute?.id === minute.id ? 'bg-blue-100' : 'hover:bg-slate-100'}`}>
                                <p className="font-semibold text-slate-800">{formatDate(minute.date)}</p>
                                <p className="text-sm text-slate-600">æ–‡è²¬: {minute.author}</p>
                            </li>
                        ))}
                    </ul>
                </Card>
            </div>
            <div className="flex-1">
                <Card className="h-full flex flex-col">
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
                        <Input type="date" value={date} onChange={e => setDate(e.target.value)} />
                        <Input type="text" placeholder="æ–‡è²¬è€…" value={author} onChange={e => setAuthor(e.target.value)} />
                    </div>
                    <div className="flex items-center gap-2 p-2 bg-slate-100 rounded-t-lg border-b border-slate-200">
                        <button onClick={() => handleFormat('bold')} className="p-2 rounded hover:bg-slate-200"><b>B</b></button>
                        <button onClick={() => handleFormat('italic')} className="p-2 rounded hover:bg-slate-200"><i>I</i></button>
                        <button onClick={() => handleFormat('underline')} className="p-2 rounded hover:bg-slate-200"><u>U</u></button>
                    </div>
                    <div ref={editorRef} contentEditable="true"
                         className="flex-1 p-4 bg-white rounded-b-lg border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 overflow-y-auto"
                         style={{ minHeight: '40vh' }}>
                    </div>
                    <div className="mt-4 flex justify-between">
                        {selectedMinute && <Button onClick={handleDelete} variant="danger">å‰Šé™¤</Button>}
                        <div className="flex-grow" />
                        <Button onClick={handleSave} variant="primary">ä¿å­˜</Button>
                    </div>
                </Card>
            </div>
        </div>
    );
};


// Appã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
function App() {
  const [page, setPage] = useState('Home');
  const [members, setMembers] = useState([]);
  const [schedules, setSchedules] = useState({});
  const [plans, setPlans] = useState([]);
  const [minutes, setMinutes] = useState([]);
  const [selectedPlan, setSelectedPlan] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [db, setDb] = useState(null);
  const [auth, setAuth] = useState(null);
  const [modal, setModal] = useState({ isOpen: false, title: '', message: '', onConfirm: null, showCancel: true, confirmText: 'OK', confirmVariant: 'primary' });

  const showModal = ({ title, message, onConfirm, showCancel = true, confirmText = 'OK', confirmVariant = 'primary' }) => {
    setModal({ isOpen: true, title, message, onConfirm, showCancel, confirmText, confirmVariant });
  };

  const closeModal = () => {
    setModal({ isOpen: false, title: '', message: '', onConfirm: null, showCancel: true, confirmText: 'OK', confirmVariant: 'primary' });
  };

  useEffect(() => {
    const initialize = async () => {
      try {
        const firebaseConfigStr = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        const firebaseConfig = JSON.parse(firebaseConfigStr);
        if (!firebaseConfig.apiKey) throw new Error("Firebase APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚");
        
        const app = initializeApp(firebaseConfig);
        const firestoreDb = getFirestore(app);
        const firestoreAuth = getAuth(app);
        
        setDb(firestoreDb);
        setAuth(firestoreAuth);
      } catch (e) {
        console.error("Firebase initialization failed:", e);
        setError(`FirebaseåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${e.message}`);
        setLoading(false);
      }
    };
    initialize();
  }, []);

  useEffect(() => {
    if (!auth) return;

    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        // Members
        const membersCollection = collection(db, `artifacts/${appId}/public/data/members`);
        const unsubMembers = onSnapshot(membersCollection, (snapshot) => {
          if (snapshot.empty) {
              initialMembers.forEach(m => setDoc(doc(membersCollection, m.id), m));
          } else {
              setMembers(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
          }
        }, (err) => { setError("ãƒ¡ãƒ³ãƒãƒ¼ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); console.error(err); });

        // Schedules
        const schedulesCollection = collection(db, `artifacts/${appId}/public/data/schedules`);
        const unsubSchedules = onSnapshot(schedulesCollection, (snapshot) => {
            if (snapshot.empty) {
                Object.entries(initialSchedules).forEach(([userId, userSchedules]) => {
                    setDoc(doc(schedulesCollection, userId), { schedules: userSchedules });
                });
            } else {
                const schedulesData = {};
                snapshot.docs.forEach(doc => { schedulesData[doc.id] = doc.data().schedules; });
                setSchedules(schedulesData);
            }
        }, (err) => { setError("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); console.error(err); });

        // Plans
        const plansCollection = collection(db, `artifacts/${appId}/public/data/plans`);
        const unsubPlans = onSnapshot(plansCollection, (snapshot) => {
            if (snapshot.empty) {
                initialPlans.forEach(p => setDoc(doc(plansCollection, p.id), p));
            } else {
                setPlans(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }
        }, (err) => { setError("è¨ˆç”»ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); console.error(err); });

        // Minutes
        const minutesCollection = collection(db, `artifacts/${appId}/public/data/minutes`);
        const q = query(minutesCollection, orderBy("date", "desc"));
        const unsubMinutes = onSnapshot(q, (snapshot) => {
            if (snapshot.empty) {
                initialMinutes.forEach(m => setDoc(doc(minutesCollection, m.id), m));
            } else {
                 setMinutes(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
            }
            setLoading(false);
        }, (err) => { setError("è­°äº‹éŒ²ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"); setLoading(false); console.error(err); });


        return () => { unsubMembers(); unsubSchedules(); unsubPlans(); unsubMinutes(); };

      } else {
        try {
          const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
          if (authToken) {
            await signInWithCustomToken(auth, authToken);
          } else {
            await signInAnonymously(auth);
          }
        } catch (err) {
            console.error("Authentication failed:", err);
            setError("èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
            setLoading(false);
        }
      }
    });

    return () => unsubscribe();
  }, [db, auth]);
  
  const renderPage = () => {
    if (loading) return <div className="flex justify-center items-center h-screen"><div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-blue-500"></div></div>;
    if (error) return <div className="p-4 sm:p-6"><Card><div className="flex items-center gap-4 text-red-600"><AlertTriangleIcon /><div><h3 className="font-bold">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h3><p>{error}</p></div></div></Card></div>;
    
    const pageProps = { db, showModal, members, plans, schedules, minutes, setPage, setSelectedPlan, setPlan: setSelectedPlan };

    switch (page) {
      case 'Home': return <HomePage {...pageProps} />;
      case 'Schedule': return <SchedulePage {...pageProps} />;
      case 'Plan': return <PlanPage {...pageProps} />;
      case 'Members': return <MembersPage {...pageProps} />;
      case 'Activities': return <ActivitiesPage {...pageProps} />;
      case 'Calendar': return <CalendarPage {...pageProps} />;
      case 'Minutes': return <MinutesPage {...pageProps} />;
      case 'PlanDetails': return <PlanDetailsPage {...pageProps} plan={selectedPlan} />;
      default: return <HomePage {...pageProps} />;
    }
  };

  const navItems = [
      { id: 'Home', label: 'ãƒ›ãƒ¼ãƒ ', icon: <HomeIcon /> },
      { id: 'Schedule', label: 'ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«', icon: <CalendarDaysIcon /> },
      { id: 'Plan', label: 'è¨ˆç”»ä½œæˆ', icon: <PlusSquareIcon /> },
      { id: 'Activities', label: 'æ´»å‹•ä¸€è¦§', icon: <ListIcon /> },
      { id: 'Calendar', label: 'ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼', icon: <MountainIcon /> },
      { id: 'Members', label: 'ãƒ¡ãƒ³ãƒãƒ¼', icon: <UsersIcon /> },
      { id: 'Minutes', label: 'è­°äº‹éŒ²', icon: <FileTextIcon /> },
  ];

  return (
    <div className="flex flex-col md:flex-row min-h-screen bg-slate-100 font-sans">
      <style>{`
        main {
          background-color: #f8fafc;
          background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
          background-size: 16px 16px;
        }
      `}</style>
      <nav className="md:w-64 bg-slate-900 text-slate-200 p-4 flex flex-col shrink-0">
        <div className="text-2xl font-bold mb-8 flex items-center gap-3 text-white">
            <MountainIcon />
            <span>Wandervogel</span>
        </div>
        <ul className="space-y-2">
          {navItems.map(item => (
             <li key={item.id}>
                <button onClick={() => setPage(item.id)} className={`w-full text-left flex items-center space-x-3 p-3 rounded-lg transition-colors ${page === item.id ? 'bg-slate-700 text-white' : 'hover:bg-slate-800 hover:text-white'}`}>
                    {item.icon}
                    <span>{item.label}</span>
                </button>
             </li>
          ))}
        </ul>
      </nav>
      <main className="flex-1 overflow-y-auto">
        {renderPage()}
      </main>
      <Modal 
        isOpen={modal.isOpen} 
        title={modal.title}
        message={modal.message}
        onConfirm={() => {
            if (modal.onConfirm) modal.onConfirm();
            closeModal();
        }}
        onCancel={closeModal}
        showCancel={modal.showCancel}
        confirmText={modal.confirmText}
        confirmVariant={modal.confirmVariant}
      />
    </div>
  );
}

export default App;
